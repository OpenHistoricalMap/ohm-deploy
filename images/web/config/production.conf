<VirtualHost *:80>
    # ServerName localhost
    # Tell Apache and Passenger where your app's 'public' directory is
    DocumentRoot /var/www/public
    PassengerRuby /usr/bin/ruby
    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} =http
    #  Development mode in case domain is localhost

    # ======Redirect to HTTPS
    RewriteCond %{HTTP_HOST} !=localhost
    RewriteCond %{HTTP_HOST} !=127.0.0.1
    RewriteCond %{HTTPS} off
    RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    # ======Redirect to wwww openhistoricalmap.org
    RewriteCond %{HTTP_HOST} =openhistoricalmap.org
    RewriteCond %{HTTP_HOST} !^www\. [NC]
    RewriteRule .* https://www.%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    <Location />
      CGIPassAuth On
    </Location>

    # ======Proxying traffic to CGImap====
    RewriteCond %{REQUEST_URI} ^/api/0\.6/map
    RewriteRule ^/api/0\.6/map(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteCond %{REQUEST_METHOD} ^(HEAD|GET)$
    RewriteRule ^/api/0\.6/(node|way|relation|changeset)/[0-9]+(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/(node|way|relation)/[0-9]+/history(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/(node|way|relation)/[0-9]+/relations(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/node/[0-9]+/ways(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/(way|relation)/[0-9]+/full(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/(nodes|ways|relations)(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]
    RewriteRule ^/api/0\.6/changeset/[0-9]+/(upload|download)(\.json|\.xml)?$ fcgi://127.0.0.1:8000$0 [P]

    #
    # Redirect non-api requests made to api.openhistoricalmap.org to www.openhistoricalmap.org
    # Testing
    #
    # RewriteCond %{HTTP_HOST} ^api\.
    # RewriteCond %{REQUEST_URI} !^/api/
    # RewriteRule ^(.*)$ https://staging.openhistoricalmap.org$1 [L,NE,R=permanent]

    # Relax Apache security settings
    <Directory /var/www/public>
      AllowOverride None
      Allow from all
      Options -MultiViews
    </Directory>
</VirtualHost>
