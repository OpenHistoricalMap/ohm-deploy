log:
  level: INFO

entryPoints:
  port:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: port-secure
  port-secure:
    address: ":443"

certificatesResolvers:
  letsencrypt:
    acme:
      email: dev@openhistoricalmap.org
      storage: /etc/traefik/acme/acme.json
      httpChallenge:
        entryPoint: port

http:
  middlewares:
    secure-headers:
      headers:
        # Protects against clickjacking
        frameDeny: true
        # Enables XSS protection in older browsers
        browserXssFilter: true
        # Prevents browsers from MIME-sniffing (forces declared Content-Type)
        contentTypeNosniff: true
        # Enforces HTTPS via HSTS
        forceSTSHeader: true
        stsSeconds: 31536000  # 1 year
        stsIncludeSubdomains: true
        stsPreload: true
        # # Trust only known proxy headers (adjust based on your infrastructure)
        # hostsProxyHeaders: ["X-Forwarded-Host"]

    secure-headers-allow-iframe:
      headers:
        # Allows iframe embedding (for comparison tools)
        frameDeny: false
        # Enables XSS protection in older browsers
        browserXssFilter: true
        # Prevents browsers from MIME-sniffing (forces declared Content-Type)
        contentTypeNosniff: true
        # Enforces HTTPS via HSTS
        forceSTSHeader: true
        stsSeconds: 31536000  # 1 year
        stsIncludeSubdomains: true
        stsPreload: true

    redirect-nominatim:
      redirectRegex:
        regex: "^https://(nominatim(?:\\.staging)?\\.openhistoricalmap\\.org)/?$"
        replacement: "https://${1}/ui/search.html"
        permanent: true

    replace-osm-to-ohm:
      replacePathRegex:
        regex: "^/capabilities/osm\\.json$"
        replacement: "/capabilities/ohm.json"

    replace-osm-tiles-to-ohm:
      replacePathRegex:
        regex: "^/maps/osm/(.*)$"
        replacement: "/maps/ohm/${1}"

  routers:
    #################### Production ####################
    vtiles-production-router:
      rule: Host(`vtiles.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: tiler_server_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers-allow-iframe

    tiler_cache-production-router:
      rule: Host(`tiler-cache.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: tiler_cache_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    nominatim-production-router:
      rule: Host(`nominatim.openhistoricalmap.org`) && !PathPrefix(`/ui`)
      entryPoints:
        - port-secure
      service: nominatim_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers
        - redirect-nominatim

    nominatim-ui-production-router:
      rule: Host(`nominatim.openhistoricalmap.org`) && PathPrefix(`/ui`)
      entryPoints:
        - port-secure
      service: nominatim_ui_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    overpass-api-production-router:
      rule: Host(`overpass-api.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: overpass_api_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    osmcha-production-router:
      rule: Host(`osmcha.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: osmcha_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    taginfo-production-router:
      rule: Host(`taginfo.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: taginfo_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    node-exporter-router:
      rule: Host(`node-exporter.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: node_exporter_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    cadvisor-router:
      rule: Host(`cadvisor.openhistoricalmap.org`)
      entryPoints:
        - port-secure
      service: cadvisor_production
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    #################### Staging ####################
    vtiles-staging-router:
      rule: Host(`vtiles.staging.openhistoricalmap.org`) || Host(`vtiles.openhistoricalmap.net`)
      entryPoints:
        - port-secure
      service: tiler_server_staging
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers-allow-iframe
        - replace-osm-to-ohm
        - replace-osm-tiles-to-ohm

    overpass-api-staging-router:
      rule: Host(`overpass-api.staging.openhistoricalmap.org`) || Host(`overpass-api.openhistoricalmap.net`)
      entryPoints:
        - port-secure
      service: overpass_api_staging
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    nominatim-staging-router:
      rule: (Host(`nominatim.staging.openhistoricalmap.org`) || Host(`nominatim.openhistoricalmap.net`)) && !PathPrefix(`/ui`)
      entryPoints:
        - port-secure
      service: nominatim_staging
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers
        - redirect-nominatim
        
    nominatim-ui-staging-router:
      rule: (Host(`nominatim.staging.openhistoricalmap.org`) || Host(`nominatim.openhistoricalmap.net`)) && PathPrefix(`/ui`)
      entryPoints:
        - port-secure
      service: nominatim_ui_staging
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers

    taginfo-staging-router:
      rule: Host(`taginfo.staging.openhistoricalmap.org`) || Host(`taginfo.openhistoricalmap.net`)
      entryPoints:
        - port-secure
      service: taginfo_staging
      tls:
        certResolver: letsencrypt
      middlewares:
        - secure-headers
    #################### Production Services ####################

  services:

    tiler_server_production:
      loadBalancer:
        servers:
          - url: http://tiler_server_production:9090

    tiler_cache_production:
      loadBalancer:
        servers:
          - url: http://tiler_sqs_cleaner_production:8000

    nominatim_production:
      loadBalancer:
        servers:
          - url: http://nominatim_production:8080

    nominatim_ui_production:
      loadBalancer:
        servers:
          - url: http://nominatim_ui_production:80

    overpass_api_production:
      loadBalancer:
        servers:
          - url: http://overpass_production:80

    osmcha_production:
      loadBalancer:
        servers:
          - url: http://frontend-nginx:80

    taginfo_production:
      loadBalancer:
        servers:
          - url: http://taginfo_production:4567

    node_exporter_production:
      loadBalancer:
        servers:
          - url: http://node-exporter:9100

    cadvisor_production:
      loadBalancer:
        servers:
          - url: http://cadvisor:8080
          
    #################### Staging services ####################

    tiler_server_staging:
      loadBalancer:
        servers:
          - url: http://tiler_server_staging:9090 #8083 comes from production

    nominatim_staging:
      loadBalancer:
        servers:
          - url: http://host.docker.internal:8083 # 8083 comes from production

    nominatim_ui_staging:
      loadBalancer:
        servers:
          - url: http://host.docker.internal:8084  # 8084 comes from production

    overpass_api_staging:
      loadBalancer:
        servers:
          - url: http://host.docker.internal:8086 # 8086 comes from production

    taginfo_staging:
      loadBalancer:
        servers:
          - url: http://host.docker.internal:8088 # 8088 comes from production

providers:
  file:
    filename: /etc/traefik/traefik.yml
    watch: true
    