#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '*'                  # Allow connections from all addresses
max_connections = 100                    # Set max connections to 120
superuser_reserved_connections = 3       # Reserve for superusers

#------------------------------------------------------------------------------
# RESOURCE USAGE
#------------------------------------------------------------------------------

# - Memory Configuration -

shared_buffers = 14GB                    # Allocate 25% of total memory
work_mem = 512MB                           # Increase per-query memory for sorting, hashing
maintenance_work_mem = 2GB                # For maintenance operations like VACUUM, ALTER
effective_cache_size = 41GB                # 75% of total memory for caching

# - Disk Optimization for SSD -

random_page_cost = 1.1                     # Lower for SSD performance
seq_page_cost = 1.0                         # Default for sequential scans

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
#------------------------------------------------------------------------------

wal_level = replica                        # Minimal for read-heavy workloads
checkpoint_timeout = 15min                  # Reduce checkpoint frequency
max_wal_size = 4GB                           # Increase to reduce writes
min_wal_size = 1GB                           # Set a lower boundary for WAL size
wal_compression = on                         # Enable compression for WAL files
synchronous_commit = off                     # Speed up transactions by avoiding full durability

#------------------------------------------------------------------------------
# AUTOVACUUM SETTINGS
#------------------------------------------------------------------------------

autovacuum_max_workers = 4                   # Run multiple autovacuum workers
autovacuum_naptime = 30s                      # Frequency of autovacuum runs
autovacuum_vacuum_cost_limit = 2000           # Increase vacuum efficiency for large data

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

effective_io_concurrency = 300                # Higher for SSD disks
parallel_tuple_cost = 0.1                      # Lower to encourage parallelism
parallel_setup_cost = 500                       # Lower setup cost for parallel processing
max_worker_processes = 28                      # Utilize CPU cores efficiently
max_parallel_workers_per_gather = 8            # Allow parallel processing for queries
max_parallel_workers = 14                       # Limit the total parallel workers

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

logging_collector = on                  # Enable logging to file
log_directory = 'pg_log'                 # Directory to store log files
log_filename = 'postgresql-%Y-%m-%d.log'  # Log file naming pattern
log_rotation_size = 100MB                 # Rotate logs at 100MB
log_truncate_on_rotation = on             # Overwrite old logs with the same name

log_min_duration_statement = 20000        # Log queries that take longer than 20 seconds (in milliseconds)

log_statement = 'none'                    # Disable logging of all statements
log_duration = off                         # Disable duration logging for all queries


#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

statement_timeout = 60000                  # Terminate queries running longer than 60 seconds (in milliseconds)
lock_timeout = 60000                        # Timeout for acquiring locks (in milliseconds)
idle_in_transaction_session_timeout = 60000 # Close idle transactions after 60 seconds (in milliseconds)


#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

datestyle = 'iso, mdy'
timezone = 'Etc/UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

default_text_search_config = 'pg_catalog.english'
